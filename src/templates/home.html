{% extends 'base.html' %}
{% load static %}

{% block title %}Главная страница{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'styles/style.css' %}">
<!-- jQuery подключен только один раз, предполагается, что в base.html он уже есть -->
<script src="{% static 'js/jquery.min.js' %}"></script>
{% endblock %}

{% block content %}
<section class="home">
<h1>Записи движения денежных средств</h1>
<img src="{% static 'images/mani.png' %}" width="200" height="200">

<form method="get">
    <fieldset>
        <legend><h1>Фильтры</h1></legend>

        <label for="date_from">Дата от:</label>
        <input type="date" id="date_from" name="date_from" value="{{ filters.date_from }}">

        <label for="date_to">до:</label>
        <input type="date" id="date_to" name="date_to" value="{{ filters.date_to }}">

        <br><br>

        <label for="status">Статус:</label>
        <select name="status" id="status">
            <option value="">Все статусы</option>
            <option value="business" {% if filters.status == 'business' %}selected{% endif %}>Бизнес</option>
            <option value="personal" {% if filters.status == 'personal' %}selected{% endif %}>Личное</option>
            <option value="tax" {% if filters.status == 'tax' %}selected{% endif %}>Налог</option>
            {% for status in statuses %}
                <option value="{{ status.id }}" {% if filters.status|stringformat:"s" == status.id|stringformat:"s" %}selected{% endif %}>{{ status.name }}</option>
            {% endfor %}
        </select>

        <br><br>

        <label for="type">Тип:</label>
        <select name="type" id="type">
            <option value="">Все типы</option>
            <option value="plus" {% if filters.type == 'plus' %}selected{% endif %}>Пополнение</option>
            <option value="minus" {% if filters.type == 'minus' %}selected{% endif %}>Списание</option>
        </select>

        <br><br>

        <!-- Категория -->
        <label for="category">Категория:</label>
        <select id="category" name="category">
            <option value="">Выберите категорию</option>
            {% for cat in category %}
                <option value="{{ cat.id }}" {% if filters.category|stringformat:"s" == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
            {% endfor %}
        </select>

        <!-- Подкатегория -->
        <label for="subcategory">Подкатегория:</label>
        <select id="subcategory" name="subcategory">
            {% if subcategory %}
                {% for sub in subcategory %}
                    <option value="{{ sub.id }}" {% if filters.subcategory|stringformat:"s" == sub.id|stringformat:"s" %}selected{% endif %}>{{ sub.name }}</option>
                {% endfor %}
            {% else %}
                <option value="">Выберите подкатегорию</option>
            {% endif %}
        </select>

        <!-- Можно добавить дополнительные фильтры по сумме, комментариям и т.п. -->

        <br><br>

        <button type="submit">Применить фильтры</button>
    </fieldset>
</form>

<!-- Таблица с записями -->
<table border="1">
    <thead>
        <tr>
            <th>Дата</th>
            <!-- Предполагается, что у модели есть ForeignKey к Status, Type, Category, Subcategory -->
            <th>Статус</th> 
            <th>Тип</th>   
            <th>Категория</th> 
            <th>Подкатегория</th> 
            <th>Сумма</th> 
            <th>Комментарий</th> 
            <th>Действия</th>
        </tr>
    </thead>
    <tbody>
        {% for record in records %}
            <tr>
                <td>{{ record.date }}</td>
                <!-- Предполагается, что у модели есть ForeignKey к Status, Type, Category, Subcategory -->
                {{ record.status.name|default:"-" }}
                {{ record.type.name|default:"-" }}
                {{ record.category.name|default:"-" }}
                {{ record.subcategory.name|default:"-" }}
                <td>{{ record.amount }}</td>       
                <td>{{ record.comment }}</td>      
                <!-- Действия: редактировать / удалять -->
                <td>
                    <!-- Предположим, есть URL с именами 'record_edit', 'record_delete', 'record_create' -->
                    <a href="{% url 'record_edit' record.id %}">Редактировать</a> |
                    <a href="{% url 'record_delete' record.id %}" onclick="return confirm('Удалить запись?')">Удалить</a>
                </td>
            </tr>
        {% empty %}
            <tr><td colspan="8">Нет записей по выбранным фильтрам.</td></tr>
        {% endfor %}
    </tbody>
</table>

<!-- Кнопка для добавления новой записи -->
<p><a href="{% url 'record_create' %}">Добавить новую запись</a></p>

<!-- Скрипты для динамической подгрузки категорий и подкатегорий -->
{% block extra_js %}
<script src="{% static 'js/jquery.min.js' %}"></script>
<script>
// Обеспечьте подключение jQuery только один раз в base.html или здесь
$(document).ready(function() {
    
    // Загрузка категорий при изменении типа
    $('#type').change(function() {
        var typeId = $(this).val();
        $.ajax({
            url: '{% url "load_categories" %}',
            data: {'type_id': typeId},
            success: function(data) {
                var categorySelect = $('#category');
                categorySelect.empty();
                categorySelect.append('<option value="">Выберите категорию</option>');
                $.each(data.categories, function(index, item) {
                    categorySelect.append('<option value="' + item.id + '">' + item.name + '</option>');
                });
                $('#subcategory').empty().append('<option value="">Выберите подкатегорию</option>');
            }
        });
    });
  
    // Загрузка подкатегорий при изменении категории
    $('#category').change(function() {
        var categoryId = $(this).val();
        $.ajax({
            url: '{% url "load_subcategory" %}',
            data: {'category_id': categoryId},
            success: function(data) {
                var subcategorySelect = $('#subcategory');
                subcategorySelect.empty();
                subcategorySelect.append('<option value="">Выберите подкатегорию</option>');
                $.each(data.subcategory, function(index, item) {
                    subcategorySelect.append('<option value="' + item.id + '">' + item.name + '</option>');
                });
            }
        });
    });
});
</script>
{% endblock %}
{% endblock %}